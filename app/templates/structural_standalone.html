<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INGEO Structures - ACI 318-25</title>
    <link rel="stylesheet" href="{{ url_for('structural_static', filename='css/structural.css') }}?v=12">
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div class="brand">
                <span class="brand-name">INGEO</span>
                <span class="brand-product">Structures</span>
            </div>
            <div class="header-divider"></div>
            <div class="header-subtitle">Verificador de Muros ACI 318-25</div>
        </header>

        <!-- Step 1: Upload -->
        <div class="card" id="upload-section">
            <div class="card-header">1. Cargar archivo Excel de ETABS</div>
            <div class="card-body">
                <div class="upload-area" id="upload-area">
                    <div class="icon">üìÑ</div>
                    <p>Arrastra tu archivo Excel aqu√≠ o haz clic para seleccionar</p>
                    <p class="hint">Tablas ETABS requeridas:</p>
                    <img src="{{ url_for('structural_static', filename='img/Tablas_Etabs.png') }}?v=3"
                         alt="Tablas ETABS soportadas"
                         class="etabs-tables-img">
                    <input type="file" id="file-input" accept=".xlsx">
                </div>
                <div class="loading" id="upload-loading">
                    <div class="spinner"></div>
                    <p>Procesando archivo...</p>
                </div>
            </div>
        </div>

        <!-- Step 2: Review Elements -->
        <div class="card hidden" id="piers-section">
            <div class="card-header">2. Revisar Elementos y Armaduras</div>
            <div class="card-body">
                <div class="section-info" id="elements-summary">
                    <div class="elements-counts">
                        <span class="element-count" id="pier-count-wrapper">
                            <strong id="pier-count">0</strong> piers
                        </span>
                        <span class="element-count hidden" id="column-count-wrapper">
                            <strong id="column-count">0</strong> columnas
                        </span>
                        <span class="element-count hidden" id="beam-count-wrapper">
                            <strong id="beam-count">0</strong> vigas
                        </span>
                    </div>
                    <p class="section-hint">Por defecto se usa armadura m√≠nima.</p>
                </div>

                <!-- Filters for Piers -->
                <div class="filters-bar" id="piers-filters">
                    <div class="filter-group">
                        <label>Grilla:</label>
                        <select id="piers-grilla-filter">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Piso:</label>
                        <select id="piers-story-filter">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Eje:</label>
                        <select id="piers-axis-filter">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>

                <!-- Global Reinforcement Config -->
                <div class="global-config">
                    <h4>Configuraci√≥n Global de Armadura</h4>
                    <div class="config-controls">
                        <div class="control-group">
                            <label>Mallas:</label>
                            <select id="global-meshes">
                                <option value="1">1 (central)</option>
                                <option value="2" selected>2 (doble cara)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Di√°metro:</label>
                            <select id="global-diameter">
                                <option value="6">œÜ6</option>
                                <option value="8" selected>œÜ8</option>
                                <option value="10">œÜ10</option>
                                <option value="12">œÜ12</option>
                                <option value="16">œÜ16</option>
                                <option value="20">œÜ20</option>
                                <option value="22">œÜ22</option>
                                <option value="25">œÜ25</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Espaciamiento:</label>
                            <select id="global-spacing">
                                <option value="100">@100</option>
                                <option value="150">@150</option>
                                <option value="200" selected>@200</option>
                                <option value="250">@250</option>
                                <option value="300">@300</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>œÜ Borde:</label>
                            <select id="global-edge-diameter">
                                <option value="10" selected>œÜ10</option>
                                <option value="12">œÜ12</option>
                                <option value="16">œÜ16</option>
                                <option value="20">œÜ20</option>
                                <option value="22">œÜ22</option>
                                <option value="25">œÜ25</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Recub. (mm):</label>
                            <select id="global-cover">
                                <option value="20">20</option>
                                <option value="25" selected>25</option>
                                <option value="30">30</option>
                                <option value="40">40</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary btn-sm" id="apply-global-btn">Aplicar a todos</button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table class="pier-edit-table" id="piers-table">
                        <thead>
                            <tr>
                                <th>Piso</th>
                                <th>Pier</th>
                                <th>Largo (m)</th>
                                <th>Espesor (m)</th>
                                <th>f'c (MPa)</th>
                                <th>Mallas</th>
                                <th>œÜ Vert</th>
                                <th>@ Vert</th>
                                <th>œÜ Horiz</th>
                                <th>@ Horiz</th>
                                <th>œÜ Borde</th>
                                <th title="Recubrimiento (mm)">Rec.</th>
                                <th>As (mm¬≤/m)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="action-bar">
                    <button class="btn btn-secondary" id="new-file-btn">Cargar otro archivo</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div class="card hidden" id="results-section">
            <div class="card-header">3. Resultados del An√°lisis</div>
            <div class="card-body">
                <!-- Elementos detectados -->
                <div class="elements-summary-bar" id="elements-summary-results">
                    <span class="elements-label">Elementos detectados:</span>
                    <span class="element-badge" id="pier-badge">
                        <strong id="pier-count-results">0</strong> piers
                    </span>
                    <span class="element-badge hidden" id="column-badge">
                        <strong id="column-count-results">0</strong> columnas
                    </span>
                    <span class="element-badge hidden" id="beam-badge">
                        <strong id="beam-count-results">0</strong> vigas
                    </span>
                </div>

                <!-- Tabs de navegaci√≥n -->
                <div class="results-tabs">
                    <button class="tab-btn active" data-tab="walls-tab">
                        <span class="tab-icon">üß±</span>
                        <span class="tab-label">Muros y Columnas</span>
                        <span class="tab-count" id="walls-tab-count">0</span>
                    </button>
                    <button class="tab-btn" data-tab="beams-tab">
                        <span class="tab-icon">üìè</span>
                        <span class="tab-label">Vigas</span>
                        <span class="tab-count" id="beams-tab-count">0</span>
                    </button>
                </div>

                <!-- TAB: Muros y Columnas -->
                <div class="tab-panel active" id="walls-tab">

                <!-- Stats + Filters (una sola fila) -->
                <div class="toolbar-bar">
                    <div class="stats-inline">
                        <span class="stat-item"><strong id="stat-total">0</strong> verificados</span>
                        <span class="stat-item stat-ok"><strong id="stat-ok">0</strong> OK</span>
                        <span class="stat-item stat-fail"><strong id="stat-fail">0</strong> Fail</span>
                        <span class="stat-item"><strong id="stat-rate">0%</strong></span>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="filter-group">
                        <label>Grilla:</label>
                        <select id="grilla-filter">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Piso:</label>
                        <select id="story-filter">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Eje:</label>
                        <select id="axis-filter">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Estado:</label>
                        <select id="status-filter">
                            <option value="">Todos</option>
                            <option value="OK">OK</option>
                            <option value="FAIL">Fail</option>
                        </select>
                    </div>
                    <div class="toolbar-divider"></div>

                    <!-- Viga Est√°ndar -->
                    <div class="standard-beam-config">
                        <span class="beam-label">Viga Est√°ndar:</span>
                        <select id="std-beam-width" title="Ancho (mm)">
                            <option value="150">150</option>
                            <option value="200" selected>200</option>
                            <option value="250">250</option>
                            <option value="300">300</option>
                        </select>
                        <span>√ó</span>
                        <select id="std-beam-height" title="Alto (mm)">
                            <option value="400">400</option>
                            <option value="500" selected>500</option>
                            <option value="600">600</option>
                            <option value="700">700</option>
                        </select>
                        <span class="beam-separator">|</span>
                        <span>L=</span>
                        <select id="std-beam-ln" title="Largo libre (mm)">
                            <option value="1000">1000</option>
                            <option value="1200">1200</option>
                            <option value="1500" selected>1500</option>
                            <option value="1800">1800</option>
                            <option value="2000">2000</option>
                            <option value="2500">2500</option>
                        </select>
                        <span class="beam-separator">|</span>
                        <select id="std-beam-nbars" title="N¬∫ barras">
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                        <span>œÜ</span>
                        <select id="std-beam-diam" title="Di√°metro barras">
                            <option value="12" selected>12</option>
                            <option value="16">16</option>
                            <option value="18">18</option>
                            <option value="20">20</option>
                            <option value="22">22</option>
                        </select>
                    </div>

                    <div class="toolbar-divider"></div>
                    <button class="btn btn-sm" id="toggle-all-combos-btn" title="Expandir/Colapsar todas las combinaciones">
                        <span id="toggle-combos-icon">‚ñ∂</span> Expandir todo
                    </button>
                    <button class="btn btn-sm btn-primary" id="generate-report-btn" title="Generar informe PDF">
                        Generar Informe
                    </button>
                    <span class="plane-indicator">M3</span>
                </div>

                <!-- Results Table -->
                <div class="table-wrapper">
                    <table class="results-table" id="results-table">
                        <thead>
                            <tr>
                                <th title="Piso / Pier / Dimensiones">Pier</th>
                                <th title="Altura desde secci√≥n cr√≠tica (continuidad del muro)">hwcs</th>
                                <th title="Malla distribuida vertical/horizontal">Malla</th>
                                <th title="Elemento de borde">Borde</th>
                                <th title="Viga de acople izquierda">V.Izq</th>
                                <th title="Viga de acople derecha">V.Der</th>
                                <th>FS Flex.</th>
                                <th>Cap. Flexi√≥n</th>
                                <th>FS Corte</th>
                                <th>Cap. Corte</th>
                                <th title="Propuesta de dise√±o si falla">Propuesta</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Summary Plot (below table) -->
                <div class="summary-plot" id="summary-plot-container"></div>

                </div><!-- Fin TAB: Muros y Columnas -->

                <!-- TAB: Vigas -->
                <div class="tab-panel" id="beams-tab">
                    <div class="beams-toolbar">
                        <div class="stats-inline">
                            <span class="stat-item"><strong id="beam-stat-total">0</strong> vigas</span>
                            <span class="stat-item stat-ok"><strong id="beam-stat-ok">0</strong> OK</span>
                            <span class="stat-item stat-fail"><strong id="beam-stat-fail">0</strong> Fail</span>
                            <span class="stat-item"><strong id="beam-stat-rate">0%</strong></span>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="results-table beams-table" id="beams-table">
                            <thead>
                                <tr>
                                    <th title="Piso / Viga / Tipo">Viga</th>
                                    <th title="Dimensiones de la secci√≥n">Secci√≥n</th>
                                    <th title="Armadura transversal">Estribos</th>
                                    <th title="Resistencia de dise√±o">œÜVn (t)</th>
                                    <th title="Demanda m√°xima">Vu (t)</th>
                                    <th title="Factor de seguridad">FS</th>
                                    <th title="Demand/Capacity Ratio">DCR</th>
                                    <th title="Combinaci√≥n cr√≠tica">Combo</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div><!-- Fin TAB: Vigas -->

                <div class="action-bar">
                    <button class="btn btn-secondary" id="new-analysis-btn">Nuevo An√°lisis</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for PM Diagram with Combination Navigator -->
    <div class="modal" id="plot-modal">
        <button class="modal-close">√ó</button>
        <div class="modal-content">
            <div class="modal-layout">
                <!-- Plot Section -->
                <div class="modal-plot-section">
                    <h3 id="modal-pier-title">Diagrama P-M</h3>
                    <div id="modal-plot-loading" class="loading">
                        <div class="spinner"></div>
                        <p>Actualizando diagrama...</p>
                    </div>
                    <img id="modal-plot-img" src="" alt="Diagrama P-M">
                    <div id="modal-combo-info" class="combo-info">
                        <div><strong>Combinaci√≥n:</strong> <span id="modal-combo-name">-</span></div>
                        <div>
                            <strong>P:</strong> <span id="modal-combo-P">-</span> tonf |
                            <strong>M2:</strong> <span id="modal-combo-M2">-</span> tonf-m |
                            <strong>M3:</strong> <span id="modal-combo-M3">-</span> tonf-m
                        </div>
                        <div>
                            <strong>M resultante:</strong> <span id="modal-combo-M">-</span> tonf-m |
                            <strong>Plano:</strong> <span id="modal-combo-angle">-</span>¬∞
                        </div>
                    </div>
                </div>

                <!-- Combination Navigator -->
                <div class="combination-navigator">
                    <h4>Navegar Combinaciones</h4>
                    <p class="nav-hint">Selecciona una combinaci√≥n para ver el diagrama P-M en su plano real.</p>
                    <div class="combo-list" id="modal-combo-list"></div>
                    <div class="combo-nav-controls">
                        <button class="combo-nav-btn" id="combo-prev-btn">‚Üê Anterior</button>
                        <span class="combo-current">
                            <span id="combo-current-index">1</span> / <span id="combo-total">1</span>
                        </span>
                        <button class="combo-nav-btn" id="combo-next-btn">Siguiente ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Pier Details/Capacities -->
    <div class="modal" id="pier-details-modal">
        <button class="modal-close">√ó</button>
        <div class="modal-content pier-details-content">
            <h3 id="pier-details-title">Detalles del Pier</h3>
            <div id="pier-details-loading" class="loading">
                <div class="spinner"></div>
                <p>Cargando datos...</p>
            </div>
            <div id="pier-details-body" class="pier-details-body">
                <!-- Informaci√≥n Geom√©trica -->
                <div class="details-section">
                    <h4>Geometr√≠a</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Largo (lw)</span>
                            <span class="detail-value" id="detail-width">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Espesor (tw)</span>
                            <span class="detail-value" id="detail-thickness">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Altura (hw)</span>
                            <span class="detail-value" id="detail-height">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">f'c</span>
                            <span class="detail-value" id="detail-fc">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">fy</span>
                            <span class="detail-value" id="detail-fy">-</span>
                        </div>
                    </div>
                </div>

                <!-- Armadura -->
                <div class="details-section">
                    <h4>Armadura</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Configuraci√≥n</span>
                            <span class="detail-value" id="detail-reinf-desc">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">As vertical</span>
                            <span class="detail-value" id="detail-as-vertical">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">As borde</span>
                            <span class="detail-value" id="detail-as-edge">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">As total flexi√≥n</span>
                            <span class="detail-value" id="detail-as-total">-</span>
                        </div>
                    </div>
                </div>

                <!-- Esbeltez -->
                <div class="details-section" id="slenderness-section">
                    <h4>Esbeltez (ACI 318-25)</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Lambda (k*lu/r)</span>
                            <span class="detail-value" id="detail-lambda">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Limite</span>
                            <span class="detail-value" id="detail-lambda-limit">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Estado</span>
                            <span class="detail-value" id="detail-slender-status">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Reducci√≥n</span>
                            <span class="detail-value" id="detail-slender-reduction">-</span>
                        </div>
                    </div>
                </div>

                <!-- Capacidades -->
                <div class="details-section capacities-section">
                    <h4>Capacidades Puras (sin interacci√≥n)</h4>
                    <div class="capacities-grid">
                        <div class="capacity-item">
                            <span class="capacity-label">Compresi√≥n</span>
                            <span class="capacity-value" id="detail-phi-pn">-</span>
                            <span class="capacity-unit">tonf</span>
                        </div>
                        <div class="capacity-item">
                            <span class="capacity-label">Momento M3</span>
                            <span class="capacity-value" id="detail-phi-mn3">-</span>
                            <span class="capacity-unit">tonf-m</span>
                        </div>
                        <div class="capacity-item">
                            <span class="capacity-label">Momento M2</span>
                            <span class="capacity-value" id="detail-phi-mn2">-</span>
                            <span class="capacity-unit">tonf-m</span>
                        </div>
                        <div class="capacity-item">
                            <span class="capacity-label">Corte V2</span>
                            <span class="capacity-value" id="detail-phi-vn2">-</span>
                            <span class="capacity-unit">tonf</span>
                        </div>
                        <div class="capacity-item">
                            <span class="capacity-label">Corte V3</span>
                            <span class="capacity-value" id="detail-phi-vn3">-</span>
                            <span class="capacity-unit">tonf</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Section Diagram -->
    <div class="modal" id="section-modal">
        <button class="modal-close">√ó</button>
        <div class="modal-content section-diagram-content">
            <h3 id="section-modal-title">Secci√≥n Transversal</h3>
            <div id="section-modal-loading" class="loading">
                <div class="spinner"></div>
                <p>Generando diagrama...</p>
            </div>
            <img id="section-modal-img" src="" alt="Secci√≥n Transversal">
        </div>
    </div>

    <!-- Modal for Analysis Progress -->
    <div class="progress-modal" id="progress-modal">
        <div class="progress-modal-content">
            <div class="progress-icon">
                <div class="spinner"></div>
            </div>
            <h3 id="progress-text">Procesando pier 0 de 0</h3>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <p class="progress-pier" id="progress-pier">Iniciando...</p>
        </div>
    </div>

    <!-- Modal for Report Configuration -->
    <div class="modal" id="report-modal">
        <button class="modal-close">√ó</button>
        <div class="modal-content report-config-content">
            <h3>Generar Informe PDF</h3>
            <div class="report-config-form">
                <!-- Project Name -->
                <div class="form-group">
                    <label for="report-project-name">Nombre del Proyecto:</label>
                    <input type="text" id="report-project-name" maxlength="100"
                           placeholder="Mi Proyecto Estructural">
                </div>

                <!-- Top Piers -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="report-top-load">Top piers por carga axial:</label>
                        <input type="number" id="report-top-load" value="5" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="report-top-cuantia">Top piers por cuantia:</label>
                        <input type="number" id="report-top-cuantia" value="5" min="1" max="100">
                    </div>
                </div>

                <!-- Include Options -->
                <div class="form-group">
                    <label>Secciones a incluir:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="report-include-failing" checked>
                            Piers que fallan verificacion
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="report-include-proposals" checked>
                            Propuestas de diseno
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="report-include-pm" checked>
                            Diagramas P-M
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="report-include-sections" checked>
                            Secciones transversales
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="report-include-full-table" checked>
                            Tabla completa de resultados
                        </label>
                    </div>
                </div>

                <!-- Validation Error -->
                <div class="form-error" id="report-error" style="display: none;"></div>

                <!-- Actions -->
                <div class="form-actions">
                    <button class="btn btn-secondary" id="report-cancel-btn">Cancelar</button>
                    <button class="btn btn-primary" id="report-generate-btn">
                        <span class="btn-text">Generar PDF</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner-small"></span> Generando...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules -->
    <script src="{{ url_for('structural_static', filename='js/Constants.js') }}?v=1"></script>
    <script src="{{ url_for('structural_static', filename='js/Utils.js') }}?v=1"></script>
    <script src="{{ url_for('structural_static', filename='js/StructuralAPI.js') }}?v=12"></script>
    <script src="{{ url_for('structural_static', filename='js/PlotModal.js') }}?v=12"></script>
    <script src="{{ url_for('structural_static', filename='js/PiersTable.js') }}?v=12"></script>
    <script src="{{ url_for('structural_static', filename='js/RowFactory.js') }}?v=1"></script>
    <script src="{{ url_for('structural_static', filename='js/ResultsTable.js') }}?v=17"></script>
    <script src="{{ url_for('structural_static', filename='js/BeamsTable.js') }}?v=1"></script>
    <script src="{{ url_for('structural_static', filename='js/ReportModal.js') }}?v=12"></script>
    <script src="{{ url_for('structural_static', filename='js/StructuralPage.js') }}?v=18"></script>
    <script>
        // Inicializar la p√°gina cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            structuralPage.init();
        });
    </script>
</body>
</html>
